#Clustering of Trichodesmium 16S sequences from Canary Island samples

##Starting point
A biom file generated by open-otu clustering of 16S reads at 97% identity using the GreenGenes_97 (v13.8) database. You will also need the seqs.fna file that was used to make this.

The following commands assume that your starting biom file is open_otus/otu_table_mc2_w_tax_no_pynast_failures.biom and your sequence file is samples/seqs.fna.

##Aim
We want to extract the subset of 16S sequences that come from Trichodesmium, and cluster these at higher levels of sequence identity (99% and above) to determine how many (sub)species we have.

##Method

###Setup

Make a new directory to carry out the analysis in.

```bash
mkdir Tricho_16S
cd Tricho_16S
```

###Extract Trichodesmium sequences from OTU table

Due to the way that the taxonomic classification works (the GG database is clustered at 97% identity, and a representative of each cluster is picked at random for use in taxonomy assignment) the Trichodesmium genus is actually labelled as Hydrocoleum.

To generate a Trichodesmium-only biom file:

```bash
filter_taxa_from_otu_table.py -i ../open_otus/otu_table_mc2_w_tax_no_pynast_failures.biom -o Tricho.biom -p g__Hydrocoleum

#To get a summary of the number of sequences in the new table:
biom summarize-table -i Tricho.biom

#To generate a text version of the otu table
biom convert -i Tricho.biom -o Tricho_otu_table.txt --to-tsv
```

Next we need to extract these same Trichodesmium sequences from the original seqs.fna file so that we can redo the clustering. (This should be easier than it is...)

First, use the text version of the OTU table to get a list of OTU IDs present in the filtered dataset

```bash
grep -v '^#' Tricho_otu_table.txt | cut -f1 > otu_list
```

Then use this list to filter the OTU mapping file (that was made when you did the original OTU picking) to keep IDs of sequences that are classed as Trichodesmium

```bash
grep -f otu_list ../open_otus/final_otu_map_mc2.txt > filtered_Tricho_otu_map.txt
```

Finally, use this list of sequence IDs to filter the original seqs.fna file to keep only the Trichodesmium sequences

```bash
filter_fasta.py -f ../samples/seqs.fna -o Tricho_seqs.fna -m filtered_Tricho_otu_map.txt
```

###De novo sequence clustering at 99% identity

Now we want to cluster the extracted sequences de novo at an identity level of 99%. QIIME clustering programs will default to clustering at 97%, so we need to provide a parameter file to override this behaviour. We also want to assign taxonomy using a database that is more specific than QIIME's default (GreenGenes, clustered at 97% identity). This example uses the full (unclustered) version of SILVA v111.

[TODO: add info on where to download this.]

Using a text editor, make a file containing the following and save it as de_novo_params99.txt

```bash
split_libraries_fastq:phred_offset  33
pick_otus:enable_rev_strand_match   True
pick_otus:similarity    0.99
assign_taxonomy:reference_seqs_fp   /research/miseq/db/Silva_111_post/rep_set/Silva_111_full_unique.fasta
assign_taxonomy:id_to_taxonomy_fp   /research/miseq/db/Silva_111_post/taxonomy/Silva_111_taxa_map_full.txt
```

Run de novo OTU picking

```bash
pick_de_novo_otus.py -i Tricho_seqs.fna -o denovo_otus99 -p de_novo_params99.txt
```

Clean up the result a little by removing very rare OTUs (<0.1% of the total) - these are likely to be sequencing errors.

```bash
filter_otus_from_otu_table.py -i denovo_otus99/otu_table.biom -o denovo_otus99/otu_table_filt0001.biom --min_count_fraction 0.001
```

###Making a phylogenetic tree:
We want to make a tree showing how the OTUs in the dataset are related. However, this will be more informative if we include some known Tricho sequences.

TODO what is the easiest way to do this?

```bash
align_seqs.py -i Hydrocoleum_filt0001.fasta -m mafft
make_phylogeny.py -i mafft_aligned/Hydrocoleum_filt0001_aligned.fasta
```
TODO then do the same for GreenGenes99

This provides all the files needed to plot phylogenetic trees and bar plots using Phyloseq in R.

